name: GitHub CI

on:
  pull_request:
  workflow_dispatch:
    inputs:
      revn:
        type: choice
        options:
        - '252'
        - '251'
        - '242'
        - '241'
        - '232'
        description: 'The Mechanical revision number to run tests on.'
        default: '242' #stable version is 242, must match $stable_container
  schedule:
    - cron: '00 22 * * *'  # UTC time, may start 5-15 mins later than scheduled time
  # registry_package:
    # Run workflow when package is published or updated
    # types: [published]
  push:
    tags:
      - "*"
    branches:
      - main
      - release/*



env:
  PYMECHANICAL_PORT: 10000  # default won't work on GitHub runners
  PYMECHANICAL_START_INSTANCE: false
  DOCKER_PACKAGE: ghcr.io/ansys/mechanical@sha256:29a551fec7355a9da2a277b199e9b04694f2cdac8e11bcc72b9501ba571d3e37
  DOCKER_MECH_CONTAINER_NAME: mechanical
  PACKAGE_NAME: ansys-mechanical-core
  DOCUMENTATION_CNAME: mechanical.docs.pyansys.com
  MAIN_PYTHON_VERSION: '3.13'
  # DEV_REVN & its Docker image are used in scheduled or registry package runs
  STABLE_REVN: '242'
  DEV_REVN: '252'
  LICENSE_SERVER: ${{ secrets.LICENSE_SERVER }}
  ANSYSLMD_LICENSE_FILE: 1055@${{ secrets.LICENSE_SERVER }}

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  update-changelog:
    name: "Update CHANGELOG for new tag"
    if: github.event_name == 'push' && contains(github.ref, 'refs/tags')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - uses: ansys/actions/doc-deploy-changelog@v8
        with:
          token: ${{ secrets.PYANSYS_CI_BOT_TOKEN }}
          bot-user: ${{ secrets.PYANSYS_CI_BOT_USERNAME }}
          bot-email: ${{ secrets.PYANSYS_CI_BOT_EMAIL }}

  revn-variations:
    name: Save variations of revn
    runs-on: ubuntu-latest
    outputs:
      stable_container: ${{ steps.save-versions.outputs.stable_container }}
      test_revn: '${{ steps.save-versions.outputs.test_revn }}'
      test_container: ${{ steps.save-versions.outputs.test_container }}
      test_docker_image_version: '${{ steps.save-versions.outputs.test_docker_image_version }}'
    steps:
      - id: save-versions
        run: |
          if ${{ github.event_name == 'schedule' }}; then
            echo "test_revn=${{ env.DEV_REVN}}" >> $GITHUB_OUTPUT
            test_mech_revn=${{ env.DEV_REVN}}
            test_mech_image_version=${test_mech_revn:0:2}.${test_mech_revn:2}_candidate
            echo "test_container=${{ env.DOCKER_PACKAGE }}:$test_mech_image_version" >> $GITHUB_OUTPUT
            echo "test_docker_image_version=$test_mech_image_version" >> $GITHUB_OUTPUT
          else
            if [[ -z "${{inputs.revn}}" ]]; then
              mech_revn=${{ env.STABLE_REVN }}
            else
              mech_revn=${{inputs.revn}}
            fi
            export mech_image_version=${mech_revn:0:2}.${mech_revn:2}.0
            echo "test_revn=$mech_revn" >> $GITHUB_OUTPUT
            echo "test_container=${{ env.DOCKER_PACKAGE }}:$mech_image_version" >> $GITHUB_OUTPUT
            echo "test_docker_image_version=$mech_image_version" >> $GITHUB_OUTPUT
          fi

          stable_mech_revn=${{ env.STABLE_REVN }}
          stable_mech_image_version=${mech_revn:0:2}.${mech_revn:2}.0
          echo "stable_container=${{ env.DOCKER_PACKAGE }}:$stable_mech_image_version" >> $GITHUB_OUTPUT

          echo $GITHUB_OUTPUT

          # --- Help ----
          # schedule nightly uses DEV_REVN candidate
          # PRs and merges use STABLE_REVN
          # Workflow dispatch can use any revision number

  config-matrix:
    runs-on: ubuntu-latest
    needs: [revn-variations]
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - id: set-matrix
        run: |
          # if a tag(release) is pushed, test all versions
          if ${{ github.event_name == 'push' }} && ${{ contains(github.ref, 'refs/tags') }}; then
            echo "matrix={\"mechanical-version\":['23.2.0', '24.1.0', '24.2.0'],\"experimental\":[false]}" >> $GITHUB_OUTPUT
          else
            echo "matrix={\"mechanical-version\":['${{ needs.revn-variations.outputs.test_docker_image_version }}'],\"experimental\":[false]}" >> $GITHUB_OUTPUT
          fi
  container-stability-check:
    runs-on: ubuntu-latest
    needs: [revn-variations]
    outputs:
      container_stable_exit: ${{ steps.check_stability.outputs.container_stable_exit }}
    steps:
      - id: check_stability
        run: |
          sudo apt update
          sudo apt install bc -y
          container_version=$(echo "${{ needs.revn-variations.outputs.test_docker_image_version }}" | grep -o -E '[0-9]+(\.[0-9]+)?' | head -n 1)
          if (( $(echo "$container_version > 24.2" | bc -l) )); then
            echo "container_stable_exit=true" >> $GITHUB_OUTPUT
          else
            echo "container_stable_exit=false" >> $GITHUB_OUTPUT
          fi

  remote-connect:
    name: Remote connect testing and coverage - Mechanical ${{ matrix.mechanical-version }}
    runs-on: public-ubuntu-latest-8-cores
    needs: [revn-variations, config-matrix]
    continue-on-error: ${{ matrix.experimental }}
    strategy:
      fail-fast: false
      matrix: ${{ fromJSON(needs.config-matrix.outputs.matrix) }}
    steps:
      - name: Login in Github Container registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull, launch, and validate Mechanical service
        env:
          MECHANICAL_IMAGE: ${{ env.DOCKER_PACKAGE }}:${{ matrix.mechanical-version }}
        run: |
          docker pull ${{ env.MECHANICAL_IMAGE }}
          docker run --restart always --name ${{ env.DOCKER_MECH_CONTAINER_NAME }} -e ANSYSLMD_LICENSE_FILE=1055@${{ env.LICENSE_SERVER }} -p ${{ env.PYMECHANICAL_PORT }}:10000 ${{ env.MECHANICAL_IMAGE }} > log.txt &
          grep -q 'WB Initialize Done' <(timeout 60 tail -f log.txt)

      - name: Display info
        id: capture_info
        run: |
          IMAGE_NAME=${{ env.DOCKER_PACKAGE }}:${{ matrix.mechanical-version }}
          BUILD_DATE=$(docker run --rm --entrypoint head $IMAGE_NAME -n 1 /install/ansys_inc/v${{ needs.revn-variations.outputs.test_revn }}/aisol/CommonFiles/builddate.txt)
          PUSHED_AT=$(docker inspect --format='{{.Created}}' $IMAGE_NAME)
          echo "docker_info=$IMAGE_NAME was pushed at: $PUSHED_AT" >> $GITHUB_OUTPUT
          echo "::group::Docker Info"
          echo "docker_info=$PUSHED_AT" >> $GITHUB_OUTPUT
          echo "build_info=$BUILD_DATE" >> $GITHUB_OUTPUT
          echo "$IMAGE_NAME pushed at $PUSHED_AT"
          echo "Build date : $BUILD_DATE"
          echo "::endgroup::"

  embedding-tests:
    name: Embedding testing and coverage
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [revn-variations, container-stability-check]
    container:
      image: ${{ needs.revn-variations.outputs.test_container }}
      options: --entrypoint /bin/bash
    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.10', '3.11', '3.12', '3.13']

    steps:
      - uses: actions/checkout@v4
      - name: Set up python and pip
        run: |
          apt update
          apt install --reinstall ca-certificates
          apt install lsb-release xvfb software-properties-common -y
          add-apt-repository ppa:deadsnakes/ppa -y
          apt install -y python${{ matrix.python-version }} python${{ matrix.python-version }}-venv
          python${{ matrix.python-version }} -m venv /env

      - name: Install packages for testing
        run: |
          . /env/bin/activate
          pip install --upgrade pip
          pip install -e .[tests]

      - name: Unit Testing and coverage
        env:
          ANSYS_WORKBENCH_LOGGING_CONSOLE: 0
          ANSYS_WORKBENCH_LOGGING: 0
          ANSYS_WORKBENCH_LOGGING_FILTER_LEVEL: 2
          NUM_CORES: 1
          PYTHONUNBUFFERED: 1
        run: |
          . /env/bin/activate
          if [ "${{ needs.container-stability-check.outputs.container_stable_exit }}" = "true" ]; then
            xvfb-run mechanical-env pytest -m embedding -s --junitxml test_results${{ matrix.python-version }}.xml
          else
            xvfb-run mechanical-env pytest -m embedding -s --junitxml test_results${{ matrix.python-version }}.xml || true
          fi

      - name: Upload coverage results
        uses: actions/upload-artifact@v4
        if: env.MAIN_PYTHON_VERSION == matrix.python-version
        with:
          include-hidden-files: true
          name: coverage-tests-embedding
          path: .cov
          retention-days: 7

      - name: Upload coverage results (as .coverage)
        uses: actions/upload-artifact@v4
        if: env.MAIN_PYTHON_VERSION == matrix.python-version
        with:
          include-hidden-files: true
          name: coverage-file-tests-embedding
          path: .coverage
          retention-days: 7

      - name: Publish Test Report
        uses: mikepenz/action-junit-report@v5
        if: always()
        with:
          report_paths: '**/test_results*.xml'
          check_name: Test Report ${{ matrix.python-version }}
          detailed_summary: true
          include_passed: true
          fail_on_failure: true

  embedding-scripts-tests:
    name: Embedding scripts testing and coverage
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [revn-variations]
    container:
      image: ${{ needs.revn-variations.outputs.test_container }}
      options: --entrypoint /bin/bash
    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.10', '3.11', '3.12', '3.13']

    steps:
      - uses: actions/checkout@v4
      - name: Set up python and pip
        run: |
          apt update
          apt install --reinstall ca-certificates
          apt install lsb-release xvfb software-properties-common -y
          add-apt-repository ppa:deadsnakes/ppa -y
          apt install -y python${{ matrix.python-version }} python${{ matrix.python-version }}-venv
          python${{ matrix.python-version }} -m venv /env

      - name: Install packages for testing
        run: |
          . /env/bin/activate
          pip install --upgrade pip
          pip install -e .[tests]

      - name: Embedding scripts unit testing and coverage
        env:
          ANSYS_WORKBENCH_LOGGING_CONSOLE: 0
          ANSYS_WORKBENCH_LOGGING: 0
          ANSYS_WORKBENCH_LOGGING_FILTER_LEVEL: 2
          NUM_CORES: 1
          PYTHONUNBUFFERED: 1
        run: |
          . /env/bin/activate
          mechanical-env pytest -m embedding_scripts -s --junitxml test_results_embedding_scripts${{ matrix.python-version }}.xml
          pytest -m cli -s --junitxml test_results_cli_scripts${{ matrix.python-version }}.xml

      - name: Upload coverage results
        uses: actions/upload-artifact@v4
        if: env.MAIN_PYTHON_VERSION == matrix.python-version
        with:
          include-hidden-files: true
          name: coverage-tests-embedding-scripts
          path: .cov
          retention-days: 7

      - name: Upload coverage results (as .coverage)
        uses: actions/upload-artifact@v4
        if: env.MAIN_PYTHON_VERSION == matrix.python-version
        with:
          include-hidden-files: true
          name: coverage-file-tests-embedding-scripts
          path: .coverage
          retention-days: 7

      - name: Publish Test Report
        uses: mikepenz/action-junit-report@v5
        if: always()
        with:
          report_paths: '**/test_results*.xml'
          check_name: Test Report ${{ matrix.python-version }}
          detailed_summary: true
          include_passed: true
          fail_on_failure: true